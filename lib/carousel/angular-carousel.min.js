/**
 * Angular Carousel - Mobile friendly touch carousel for AngularJS
 * @version v0.0.8 - 2013-08-13
 * @link http://revolunet.github.com/angular-carousel
 * @author Julien Bouquillon <julien@revolunet.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
angular.module("angular-carousel",["ngMobile"]),angular.module("angular-carousel").directive("rnCarouselIndicators",[function(){return{restrict:"A",replace:!0,scope:{items:"=",index:"="},template:'<div class="rn-carousel-indicator"><span ng-repeat="item in items" ng-class="{active: $index==$parent.index}">‚óè</span></div>'}}]),angular.module("angular-carousel").directive("rnCarouselInfinite",["$parse","$compile",function(t){return{restrict:"EA",transclude:!0,replace:!0,scope:!0,template:"<ul rn-carousel rn-carousel-buffered><li ng-transclude></li></ul>",compile:function(e,n){var i=n.rnCarouselCurrent+" in items";return e.find("li").attr("ng-repeat",i),function(e,n,i){e.items=[t(i.rnCarouselCurrent)(e)],e.$watchCollection("carouselCollection.position",function(n){t(i.rnCarouselCurrent).assign(e.$parent,e.items[n])})}}}}]),angular.module("angular-carousel").directive("rnCarousel",["$compile","$parse","$swipe","$document","$window","CollectionManager",function(t,e,n,i,s,r){var o=0;return{restrict:"A",scope:!0,compile:function(a,l){a.addClass("rn-carousel-slides");var u=a.find("li")[0].attributes,c=u["ng-repeat"];if(c||(c=u["data-ng-repeat"]),c||(c=u["x-ng-repeat"]),!c)throw Error("carousel: cannot find the ngRepeat attribute");var f=c.value.match(/^\s*(.+)\s+in\s+(.*?)\s*(\s+track\s+by\s+(.+)\s*)?$/),h=f[1],d=f[2],p=f[3]||"",g=angular.isDefined(l.rnCarouselBuffered);return c.value=h+" in carouselCollection.cards "+p,function(a,l,u){function c(t){var e=angular.element(t).css("transform").match(/translate3d\((-?\d+(?:px)?),\s*(-?\d+(?:px)?),\s*(-?\d+(?:px)?)\)/);return e?e.slice(1,3):[0,0,0]}function f(t){!t.target||t.target!==E[0]||"transform"!==t.propertyName&&"-webkit-transform"!==t.propertyName&&"-moz-transform"!==t.propertyName||(a.$apply(function(){m(),a.carouselCollection.adjustBuffer(),b(!0)}),E.css(C(c(E[0]),!0)))}function h(t,e){function n(){D=!0,a.carouselCollection[t](e,!0)}a.$$phase?n():a.$apply(n)}function p(t,e){var n="after"===t?"push":"unshift";e&&(angular.isObject(e.promise)?e.promise.then(function(t){t&&h(n,t)}):angular.isFunction(e.then)?e.then(function(t){t&&h(n,t)}):h(n,e))}function m(){var t=a.carouselCollection.position,n=a.carouselCollection.getLastIndex(),i=null;0===t&&angular.isDefined(u.rnCarouselPrev)&&(i=e(u.rnCarouselPrev)(a,{item:a.carouselCollection.cards[0]}),p("before",i)),t===n&&angular.isDefined(u.rnCarouselNext)&&(i=e(u.rnCarouselNext)(a,{item:a.carouselCollection.cards[a.carouselCollection.cards.length-1]}),p("after",i))}function x(t,e){var n={};return n[t]=e,angular.forEach(R,function(i){n["-"+i.toLowerCase()+"-"+t]=e}),n}function C(t,e){return e?x("transform","translate3d("+t+"px,0,0)"):x("transform","translate("+t+"px,0)")}function v(){y(),b()}function y(){j.css("width","auto"),D=!0;var t=E.find("li");return T=0===t.length?E[0].getBoundingClientRect().width:t[0].getBoundingClientRect().width,j.css("width",T+"px"),T}function b(t){D=!!t||D,0===T&&y(),L=a.carouselCollection.getRelativeIndex()*-T,D===!0?E.removeClass("rn-carousel-animate").addClass("rn-carousel-noanimate").css(C(L,!1)):E.removeClass("rn-carousel-noanimate").addClass("rn-carousel-animate").css(C(L,!0)),D=!1}function I(t){if(i.unbind("mouseup",w),0===T&&y(),M>1){var e=a.carouselCollection.getLastIndex(),n=a.carouselCollection.position,s=B>L?1:-1,r=Math.min(Math.max(0,n+s),e),o=t.x-S;T*z>=Math.abs(o)&&(r=n);var l=n!==r;l?a.$apply(function(){angular.isDefined(u.rnCarouselCycle)&&(a.carouselCollection.position=r,b()),a.carouselCollection.goTo(r,!0)}):a.$apply(function(){b()})}M=0}function w(t){I({x:t.clientX,y:t.clientY})}o++;var $="rn-carousel-"+o,M=0,S=0,B=0,L=0,z=.1,T=0,D=!0,E=l.wrap("<div id='"+$+"' class='rn-carousel-container'></div>"),j=E.parent(),A=e(d),N={},O=0;if(u.rnCarouselIndex){var k=e(u.rnCarouselIndex);angular.isFunction(k.assign)?(a.$watch("carouselCollection.index",function(t){k.assign(a.$parent,t)}),O=k(a),a.$parent.$watch(k,function(t){void 0!==t&&a.carouselCollection.goToIndex(t,!0)})):isNaN(u.rnCarouselIndex)||(O=parseInt(u.rnCarouselIndex,10))}angular.isDefined(u.rnCarouselCycle)&&(N.cycle=!0),N.index=O,g&&(N.bufferSize=3,N.buffered=!0),a.carouselCollection=r.create(N),a.$watch("carouselCollection.updated",function(t){t&&b()});var P=!1;a.$watch(A,function(t){a.carouselCollection.setItems(t,P),P=!0,0===T&&y(),b()}),angular.isDefined(u.rnCarouselWatch)&&a.$watch(d,function(t){a.carouselCollection.setItems(t,!1),P=!0,0===T&&y(),b()},!0);var R=["webkit","moz"];if(E[0].addEventListener("webkitTransitionEnd",f,!1),E[0].addEventListener("transitionend",f,!1),window.addEventListener("orientationchange",v),window.addEventListener("resize",v),angular.isDefined(u.rnCarouselIndicator)){var F=t("<div id='"+$+"-indicator' index='carouselCollection.index' items='carouselCollection.items' data-rn-carousel-indicators class='rn-carousel-indicator'></div>")(a);j.append(F)}var W=null,X=s.jasmine||"iPad"==s.navigator.platform?0:50;n.bind(E,{start:function(t){0===M&&(M=1,S=t.x),i.bind("mouseup",w)},move:function(t){if(0!==M){var e=t.x-S;if(1===M&&0!==e)M=2,B=L;else if(2===M){var n=(new Date).getTime();if(W&&X>n-W)return;W=n;var i=a.carouselCollection.getLastIndex(),s=a.carouselCollection.position,r=1;(0===s&&t.x>S||s===i&&S>t.x)&&(r=3),L=B+e/r,E.css(C(L,!0)).removeClass("rn-carousel-animate").addClass("rn-carousel-noanimate")}}},end:function(t){I(t)}})}}}}]),angular.module("angular-carousel").service("CollectionManager",[function(){function t(t){var e,n={bufferSize:0,bufferStart:0,buffered:!1,cycle:!1,cycleOffset:0,index:0,position:0,items:[],cards:[],updated:null,debug:!1};if(t)for(e in t)n[e]=t[e];for(e in n)this[e]=n[e];angular.extend(this,n,t),this.init()}return t.prototype.log=function(){this.debug&&console.log.apply(console,arguments)},t.prototype.getPositionFromIndex=function(t){return(t+this.cycleOffset)%this.length()},t.prototype.goToIndex=function(t,e){if(t=Math.max(0,Math.min(t,this.getLastIndex())),this.updated&&t===this.index)return this.log("skip position change(same)"),!1;var n=this.getPositionFromIndex(t);return this.goTo(n,e)},t.prototype.goTo=function(t,e){if(this.log("goto start",t,e),0===this.length())return this.log("empty, skip gotoIndex"),void 0;t=Math.max(0,Math.min(t,this.getLastIndex()));var n=!1;this.cycle&&(0===t?(this.log("cycleAtBeginning",t),this.cycleAtBeginning(),t=1,this.cycleOffset++,n=!0):t===this.getLastIndex()&&(this.log("cycleAtEnd",t),this.cycleAtEnd(),t--,this.cycleOffset--,n=!0),this.cycleOffset%=this.length()),this.position=Math.max(0,Math.min(t,this.getLastIndex()));var i=(this.position-this.cycleOffset+this.length())%this.length();this.index=Math.max(0,Math.min(i,this.getLastIndex())),e||this.adjustBuffer(),n||(this.updated=new Date)},t.prototype.next=function(){this.cycle?this.goTo((this.position+1)%this.length()):this.goTo(Math.min(this.position+1,this.getLastIndex()))},t.prototype.prev=function(){if(this.cycle)this.goTo((this.position-1+this.length())%this.length());else{var t=this.length()>0?Math.max(0,(this.position-1)%this.length()):0;this.goTo(t)}},t.prototype.setBufferSize=function(t){this.log("setBufferSize",t),this.bufferSize=t,this.adjustBuffer()},t.prototype.isBuffered=function(){return this.buffered},t.prototype.getRelativeIndex=function(){var t=Math.max(0,Math.min(this.getLastIndex(),this.position-this.bufferStart));return t},t.prototype.adjustBuffer=function(){var t=(this.getLastIndex()+1-this.bufferSize)%this.length();this.log("maxBufferStart",t),this.bufferStart=Math.max(0,Math.min(t,this.position-1)),this.cards=this.items.slice(this.bufferStart,this.bufferStart+this.bufferSize),this.log("adjustBuffer from",this.bufferStart,"to",this.bufferStart+this.bufferSize)},t.prototype.length=function(){return this.items.length},t.prototype.getLastIndex=function(){var t=Math.max(0,this.length()-1);return t},t.prototype.init=function(){this.setBufferSize(this.isBuffered()?this.bufferSize:this.length()),this.length()>0&&this.goToIndex(this.index)},t.prototype.setItems=function(t,e){this.log("setItems",t,e),e&&(this.index=0,this.position=0),this.items=t||[],this.init()},t.prototype.cycleAtEnd=function(){this.push(this.items.shift())},t.prototype.push=function(t,e){this.log("push item(s)",t,e),this.items.push(t),e&&(this.adjustBuffer(),this.updated=new Date),this.buffered||this.bufferSize++},t.prototype.unshift=function(t,e){this.log("unshift item(s)",t,e),this.items.unshift(t),this.buffered||this.bufferSize++,e&&(this.position++,this.adjustBuffer(),this.updated=new Date)},t.prototype.cycleAtBeginning=function(){this.unshift(this.items.pop())},{create:function(e){return new t(e)}}}]);